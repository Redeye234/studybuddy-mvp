<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="/web/manifest.webmanifest" />
    <title>StudyBuddy+</title>
    <style>
      body{font-family:system-ui, Arial, sans-serif;margin:0;padding:0;background:#0b1020;color:#e9ebf1}
      header{padding:16px 20px;border-bottom:1px solid #1e2746;display:flex;gap:12px;align-items:center}
      main{padding:20px;max-width:960px;margin:0 auto}
      .card{background:#131a33;border:1px solid #1e2746;border-radius:12px;padding:16px;margin-bottom:16px}
      input,button,select{padding:10px;border-radius:8px;border:1px solid #33406c;background:#0b1020;color:#e9ebf1}
      button{cursor:pointer}
      .row{display:flex;gap:12px;flex-wrap:wrap}
      .hidden{display:none}
      .pill{background:#1e2746;border-radius:999px;padding:4px 10px;font-size:12px}
      a{color:#9ec1ff}
    </style>
  </head>
  <body>
    <header>
      <strong>ðŸ“š StudyBuddy+</strong>
      <span class="pill" id="plan">tier_free</span>
      <span style="flex:1"></span>
      <button id="activate">Go Premium</button>
    </header>
    <main>
      <section class="card">
        <h3>Upload Notes â†’ Summary + Flashcards</h3>
        <div class="row">
          <input type="file" id="file" accept="application/pdf,image/*,.txt" />
          <button id="upload">Upload</button>
        </div>
        <pre id="summary" class="hidden"></pre>
      </section>

      <section class="card">
        <h3>Public Focus Room</h3>
        <div class="row">
          <button id="joinRoom">Join Room</button>
          <button id="startPomodoro">Start 25m</button>
          <button id="stopPomodoro">Stop</button>
        </div>
        <div id="roomLog" style="margin-top:10px;font-family:monospace"></div>
      </section>

      <section class="card">
        <h3>Meme Break</h3>
        <div class="row">
          <button id="showMeme">Show Meme</button>
          <a id="shareMeme" class="hidden" target="_blank">Share</a>
        </div>
        <div id="meme"></div>
      </section>
    </main>

    <script>
      let TOKEN = localStorage.getItem('sb_token') || '';
      async function ensureAuth(){
        if (!TOKEN){
          const email = `demo+${Math.floor(Math.random()*10000)}@local`; 
          const res = await fetch('http://localhost:8000/v1/auth/email', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email})}).then(r=>r.json());
          TOKEN = res.token; localStorage.setItem('sb_token', TOKEN);
          document.getElementById('plan').textContent = res.user.plan;
        }
      }

      const api = (path, opts={}) => fetch(`http://localhost:8000/v1${path}`, { 
        headers: { 'Authorization': `Bearer ${TOKEN}` , ...(opts.headers||{})}, ...opts 
      }).then(async r => { if(!r.ok){ const t=await r.text(); throw new Error(`${r.status}: ${t}`);} return r.json();});

      document.addEventListener('DOMContentLoaded', async () => { await ensureAuth(); });

      document.getElementById('activate').onclick = async () => {
        const res = await api('/subscription/activate', {method:'POST'});
        document.getElementById('plan').textContent = res.plan;
      };

      document.getElementById('upload').onclick = async () => {
        await ensureAuth();
        const f = document.getElementById('file').files[0];
        if (!f) return alert('Pick a file');
        const fd = new FormData(); fd.append('file', f);
        try{
          const uploaded = await fetch('http://localhost:8000/v1/notes', {method:'POST', headers: {'Authorization': `Bearer ${TOKEN}`}, body: fd}).then(async r=>{ if(!r.ok){ throw new Error(await r.text()); } return r.json();});
          const job = await api(`/notes/${uploaded.id}/summarize`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({})});
          // Poll job until completed
          let tries = 0; let status = 'queued';
          while (tries < 60 && status !== 'completed'){
            await new Promise(r=>setTimeout(r, 1000));
            const j = await api(`/jobs/${job.job_id}`);
            status = j.status;
            if (status === 'error') { throw new Error(j.error || 'summarize failed'); }
            tries++;
          }
          const sum = await api(`/notes/${uploaded.id}/summary`);
          const pre = document.getElementById('summary');
          pre.textContent = sum.summary_text; pre.classList.remove('hidden');
        }catch(e){ alert(`Upload failed: ${e}`); }
      };

      let ws;
      function log(msg){ const el = document.getElementById('roomLog'); el.innerHTML += msg+"<br/>"; }

      document.getElementById('joinRoom').onclick = () => {
        ws = new WebSocket('ws://localhost:8000/v1/rooms/public-room/socket');
        ws.onmessage = (e)=>{ const data = JSON.parse(e.data); log(`${data.event}: ${JSON.stringify(data.payload||data)}`); };
        ws.onopen = ()=> log('connected');
        ws.onclose = ()=> log('disconnected');
      };

      document.getElementById('startPomodoro').onclick = async () => {
        await api('/rooms/public-room/sessions/start', {method:'POST'});
        if (ws) ws.send(JSON.stringify({tick: 0, started: true}));
      };
      document.getElementById('stopPomodoro').onclick = async () => {
        await api('/rooms/public-room/sessions/stop', {method:'POST'});
        if (ws) ws.send(JSON.stringify({stopped: true}));
      };

      document.getElementById('showMeme').onclick = async () => {
        const m = await api('/memes/random?category=focus');
        document.getElementById('meme').innerHTML = `<img src="${m.url}" style="max-width:100%;border-radius:8px"/>`;
        const share = document.getElementById('shareMeme');
        share.href = `https://api.whatsapp.com/send?text=${encodeURIComponent(m.url)}`;
        share.classList.remove('hidden');
      };
    </script>
  </body>
  </html>
